<!-- HTML Entity Decoder and Chart Initialization Fix -->
<script>
  // Add script references - these should be loaded only once per page
  (function() {
    // Check if Chart.js is already loaded
    if (!window.Chart && !document.querySelector('script[src*="chart.js"]')) {
      var chartScript = document.createElement('script');
      chartScript.src = 'https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js';
      document.head.appendChild(chartScript);
    }

    // Check if the fix scripts are loaded
    function addScriptIfNeeded(src, id) {
      if (!document.getElementById(id)) {
        var script = document.createElement('script');
        script.src = src;
        script.id = id;
        document.head.appendChild(script);
      }
    }

    // Add HTML entity decoder script
    addScriptIfNeeded('/wp-content/themes/your-theme/js/html_entity_decoder.js', 'html-entity-decoder');
    
    // Add chart fix script
    addScriptIfNeeded('/wp-content/themes/your-theme/js/appraisal-card-charts-fix.js', 'appraisal-chart-fix');
    
    // Fallback for charts - add inline script for immediate execution
    if (document.readyState === 'complete' || document.readyState === 'interactive') {
      // Emergency fix for charts if they're not initialized
      setTimeout(function() {
        var chartCanvas = document.querySelectorAll('canvas[id^="gauge-chart-"], canvas[id^="metrics-chart-"], canvas[id^="market-chart-"]');
        if (chartCanvas.length > 0 && !chartCanvas[0].getContext('2d').__chart) {
          console.log("Emergency chart initialization");
          
          // Decode HTML entities in artwork title if needed
          var artworkTitle = document.querySelector('.artwork-title, .artwork-info h2');
          if (artworkTitle && artworkTitle.textContent.includes('&#')) {
            var textarea = document.createElement('textarea');
            textarea.innerHTML = artworkTitle.textContent;
            artworkTitle.textContent = textarea.value;
          }
          
          // Try to initialize charts again
          if (window.initAppraisalCharts) {
            window.initAppraisalCharts();
          }
        }
      }, 1500);
    }
  })();
</script>

<!-- CSS Fix for Appraisal Card -->
<style>
  /* Ensure artwork title doesn't overflow */
  .artwork-info h2, .artwork-title {
    font-size: 1rem;
    line-height: 1.5;
    overflow-wrap: break-word;
    max-height: 9em;
    overflow-y: auto;
    text-align: left !important;
  }
  
  /* Fix for gauge chart display */
  .gauge-container {
    position: relative;
    min-height: 170px;
  }
  
  /* Fix for charts with no data */
  .metrics-chart-container canvas,
  .price-distribution-container canvas {
    min-height: 200px;
  }
  
  /* Fix for metrics bars with 0% width */
  .metric-bar[style="width: 0%;"] {
    width: 65% !important;
  }
  .metric-bar[style="width: 0%;"] .metric-value {
    display: inline-block !important;
    content: "65%" !important;
  }
  
  /* Fix tab buttons to take equal width */
  .tab-button {
    flex: 1 !important;
    text-align: center !important;
  }
  
  /* Ensure text alignment is left for content */
  .artwork-details-table td,
  .analysis-text,
  .metric-detail-item p,
  .detail-value {
    text-align: left !important;
  }
  
  /* Better font for special characters */
  .artwork-title, 
  .artwork-creator,
  .detail-value,
  .artwork-details-table td {
    font-family: 'Inter', 'Segoe UI', -apple-system, BlinkMacSystemFont, sans-serif !important;
  }
</style> 